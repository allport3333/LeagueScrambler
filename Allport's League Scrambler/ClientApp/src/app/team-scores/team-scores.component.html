<div *ngIf="loading" style="height: 200px; width: 400px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <h2 class="ml-4">Loading...</h2>
    <mat-spinner diameter="200"></mat-spinner>
</div>

<div class="row justify-content-center" *ngIf="!loading">
    <div class="col-10">
        <mat-card class="mt-2" style="background-color: lightgray;">
            <mat-tab-group>
                <!-- TAB 1: Team Scores -->
                <mat-tab label="Team Scores">
                    <div class="d-flex justify-content-center">
                        <table *ngIf="teams != null" class="table" style="max-width:600px;">
                            <thead>
                                <tr>
                                    <th>Team Name</th>
                                    <th>Total Wins</th>
                                    <th>Total Losses</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let singleTeam of teams">
                                    <td>{{ singleTeam.teamName }}</td>
                                    <td>{{ singleTeam.totalWins }}</td>
                                    <td>{{ singleTeam.totalLosses }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </mat-tab>

                <!-- TAB 2: Individual Team Scores -->
                <!-- TAB 2: Individual Team Scores -->
                <mat-tab label="Individual Team Scores">
                    <div class="text-center" style="margin-top: 20px;">
                        <!-- Date Picker and Button -->
                        <mat-form-field appearance="outline">
                            <mat-label>Select Date</mat-label>
                            <input matInput [matDatepicker]="picker" placeholder="Choose a date" [(ngModel)]="initialDate" [ngModelOptions]="{standalone: true}">
                            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                        </mat-form-field>

                        <button class="ml-2" (click)="getTeamScores()" mat-raised-button color="primary">
                            Get Date's Scores
                        </button>

                        <!-- Grouped Team Scores -->
                        <div class="d-flex flex-wrap justify-content-center mt-4">
                            <!-- Loop through grouped team scores -->
                            <mat-card *ngFor="let teamGroup of groupScoresByTeam()" class="score-card mx-3 my-3">
                                <mat-card-header>
                                    <mat-card-title>
                                        {{ teamGroup[0].teamName }}
                                    </mat-card-title>
                                    <mat-card-subtitle>
                                        Games Played on {{ initialDate | date: 'mediumDate' }}
                                    </mat-card-subtitle>
                                </mat-card-header>

                                <mat-divider></mat-divider>

                                <!-- Table for Team's Game Details -->
                                <mat-card-content>
                                    <table mat-table [dataSource]="teamGroup" class="mat-elevation-z2">

                                        <!-- Score Column -->
                                        <ng-container matColumnDef="teamScore">
                                            <th mat-header-cell *matHeaderCellDef> Team Score </th>
                                            <td mat-cell *matCellDef="let game">
                                                {{ game.teamScore }}
                                            </td>
                                        </ng-container>

                                        <!-- Win/Loss Column -->
                                        <ng-container matColumnDef="wonGame">
                                            <th mat-header-cell *matHeaderCellDef> Result </th>
                                            <td mat-cell *matCellDef="let game">
                                                <span [ngClass]="game.wonGame ? 'win-badge' : 'loss-badge'">
                                                    {{ game.wonGame ? 'Win' : 'Loss' }}
                                                </span>
                                            </td>
                                        </ng-container>

                                        <!-- Date Column -->
                                        <ng-container matColumnDef="date">
                                            <th mat-header-cell *matHeaderCellDef> Date </th>
                                            <td mat-cell *matCellDef="let game">
                                                {{ game.date | date: 'short' }}
                                            </td>
                                        </ng-container>

                                        <!-- Opponent Column -->
                                        <ng-container matColumnDef="opponentsTeamName">
                                            <th mat-header-cell *matHeaderCellDef> Opponent </th>
                                            <td mat-cell *matCellDef="let game">
                                                {{ game.opponentsTeamName }}
                                            </td>
                                        </ng-container>

                                        <!-- Header and Rows -->
                                        <tr mat-header-row *matHeaderRowDef="['teamScore', 'wonGame', 'date', 'opponentsTeamName']"></tr>
                                        <tr mat-row *matRowDef="let row; columns: ['teamScore', 'wonGame', 'date', 'opponentsTeamName'];"></tr>
                                    </table>
                                </mat-card-content>
                            </mat-card>
                        </div>
                    </div>
                </mat-tab>



                <!-- TAB 3: Enter Team Scores -->
                <mat-tab *ngIf="userRole === 'Admin' || userRole === 'Manager'" label="Enter Team Scores">
                    <div class="container-fluid">
                        <!-- Loading Spinner -->
                        <div [hidden]="!newTeamScoreLoading" class="loading-overlay">
                            <h2>Loading...</h2>
                            <mat-spinner diameter="100"></mat-spinner>
                        </div>

                        <div [hidden]="newTeamScoreLoading">
                            <h2 class="text-center my-4">Enter Team Scores</h2>

                            <!-- Number of Games Selector -->
                            <div class="row justify-content-center mb-2">
                                <mat-form-field appearance="outline">
                                    <mat-label>Number of Games</mat-label>
                                    <mat-select [(ngModel)]="numberOfGames" [ngModelOptions]="{standalone: true}" (selectionChange)="adjustScoreInputs()">
                                        <mat-option *ngFor="let num of [1,2,3,4,5,6,7,8,9,10]" [value]="num">
                                            {{ num }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <form [formGroup]="TeamScoresForm" (ngSubmit)="onSubmitClick()">
                                <div class="row justify-content-center">
                                    <!-- Team 1 Card -->
                                    <mat-card class="team-card mx-4 my-2">
                                        <mat-card-header>
                                            <mat-card-title>Team 1</mat-card-title>
                                        </mat-card-header>
                                        <mat-card-content>
                                            <mat-form-field appearance="outline" class="full-width">
                                                <mat-label>Team 1 Name</mat-label>
                                                <mat-select [(ngModel)]="selectedTeam1" [ngModelOptions]="{standalone: true}">
                                                    <mat-option *ngFor="let team1 of teams" [value]="team1">
                                                        {{ team1.teamName }}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>

                                            <div class="score-grid">
                                                <ng-container *ngFor="let i of [].constructor(numberOfGames); let idx = index">
                                                    <mat-form-field appearance="outline" class="score-input">
                                                        <mat-label>Game {{ idx + 1 }} Score</mat-label>
                                                        <input matInput type="number" placeholder="0" [formControlName]="'team1Score' + idx" />
                                                    </mat-form-field>
                                                </ng-container>
                                            </div>
                                        </mat-card-content>
                                    </mat-card>

                                    <!-- VS Divider -->
                                    <div class="vs-divider">
                                        <h3>VS</h3>
                                    </div>

                                    <!-- Team 2 Card -->
                                    <mat-card class="team-card mx-4 my-2">
                                        <mat-card-header>
                                            <mat-card-title>Team 2</mat-card-title>
                                        </mat-card-header>
                                        <mat-card-content>
                                            <mat-form-field appearance="outline" class="full-width">
                                                <mat-label>Team 2 Name</mat-label>
                                                <mat-select [(ngModel)]="selectedTeam2" [ngModelOptions]="{standalone: true}">
                                                    <mat-option *ngFor="let team2 of teams" [value]="team2">
                                                        {{ team2.teamName }}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>

                                            <div class="score-grid">
                                                <ng-container *ngFor="let i of [].constructor(numberOfGames); let idx = index">
                                                    <mat-form-field appearance="outline" class="score-input">
                                                        <mat-label>Game {{ idx + 1 }} Score</mat-label>
                                                        <input matInput type="number" placeholder="0" [formControlName]="'team2Score' + idx" />
                                                    </mat-form-field>
                                                </ng-container>
                                            </div>
                                        </mat-card-content>
                                    </mat-card>
                                </div>

                                <!-- Date and Password -->
                                <div class="row justify-content-center mt-3">
                                    <mat-form-field appearance="outline" class="mx-2">
                                        <mat-label>Date</mat-label>
                                        <input matInput
                                               [matDatepicker]="picker"
                                               formControlName="date"
                                               required>
                                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                        <mat-datepicker #picker></mat-datepicker>
                                    </mat-form-field>
                                </div>

                                <!-- Action Buttons -->
                                <div class="text-center mt-2">
                                    <button mat-raised-button color="primary" type="submit">Submit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </mat-tab>


                <!-- TAB 4: Add Team -->
                <!--<mat-tab *ngIf="userRole === 'Admin' || userRole === 'Manager'" label="Add Team">
        <h4 class="text-center mt-3">Add Team</h4>
        <form [formGroup]="NewTeamForm" class="text-center">
            <mat-form-field style="max-width:180px;" appearance="outline">
                <mat-label>New Team Name</mat-label>
                <input matInput placeholder="Team Name" type="text" formControlName="newTeamName" required />
            </mat-form-field>
            <br />
            <mat-form-field style="max-width:180px; margin-top:10px;" appearance="outline">
                <mat-label>Password</mat-label>
                <input matInput placeholder="Password" type="password" formControlName="password" required />
            </mat-form-field>
            <br />
            <button (click)="addTeam()" mat-raised-button color="primary" style="margin-top:10px;">Add Team</button>
        </form>
    </mat-tab>-->

                <mat-tab label="League Teams">
                    <app-league-teams [leagueId]="leagueID" style="width: 100%;"></app-league-teams>
                </mat-tab>

                <!-- TAB #3: Team Management (only if user is admin or manager) -->
                <mat-tab *ngIf="userRole === 'Admin' || userRole === 'Manager'" label="Team Management">
                    <app-team-management [leagueId]="leagueID" style="width: 150%;"></app-team-management>
                </mat-tab>

            </mat-tab-group>
        </mat-card>
    </div>
</div>
